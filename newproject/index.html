<!DOCTYPE html>
<html lang="es" class="h-full bg-slate-100">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel de Ventas y Metas — PWA</title>

  <!-- Tailwind local (asegúrate de compilarlo y guardarlo en assets/css/tailwind.min.css) -->
  <link rel="stylesheet" href="./assets/css/tailwind.min.css">

  <!-- Manifest -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0ea5e9">

  <!-- Lucide icons local UMD -->
  <script defer src="./assets/js/lucide.min.js"></script>

  <style>
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .tab-btn { padding: .6rem 1rem; font-weight: 500; color: #6b7280; border-bottom: 2px solid transparent; border-radius: .375rem .375rem 0 0; }
    .tab-btn.active { color:#0ea5e9; border-bottom-color:#0ea5e9; }
    .tab-content { padding: 1rem; background: white; border-radius:.5rem; box-shadow: 0 1px 4px rgba(2,6,23,.04); }
    #toast { transition: transform .25s ease, opacity .25s ease; }
  </style>
</head>
<body class="h-full text-slate-800">

  <!-- Header -->
  <header class="bg-slate-800 text-white shadow-lg">
    <div class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
      <h1 class="text-2xl font-bold tracking-tight">Panel de Control de Ventas</h1>
      <div id="db-status" class="text-xs text-red-400">Conectando a BD...</div>
    </div>
  </header>

  <!-- Main -->
  <main class="container mx-auto max-w-7xl p-4 sm:px-6 lg:px-8 py-6">

    <!-- Tabs -->
    <div class="mb-4 border-b border-gray-200">
      <ul class="flex flex-wrap -mb-px">
        <li><button class="tab-btn active" id="tab-btn-dashboard" onclick="showTab('dashboard')">Dashboard</button></li>
        <li><button class="tab-btn" id="tab-btn-metas" onclick="showTab('metas')">Metas</button></li>
        <li><button class="tab-btn" id="tab-btn-ventas" onclick="showTab('ventas')">Registro y Promotores</button></li>
        <li><button class="tab-btn" id="tab-btn-settings" onclick="showTab('settings')">Configuración</button></li>
      </ul>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="tab-content space-y-6">
      <h2 class="text-xl font-semibold text-slate-700">Avances Generales (Mes Actual)</h2>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 bg-white p-4 rounded-lg shadow-inner border border-slate-200">
          <h3 class="text-lg font-medium mb-3">Avance por Producto</h3>
          <div class="h-64 md:h-80">
            <canvas id="barChart"></canvas>
          </div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-inner border border-slate-200">
          <h3 class="text-lg font-medium mb-3">Meta General del Mes</h3>
          <div class="h-64 md:h-80 flex items-center justify-center relative">
            <canvas id="donutChart"></canvas>
            <div id="donut-percentage" class="absolute text-3xl font-bold text-slate-700">0%</div>
          </div>
        </div>
      </div>

      <div>
        <h2 class="text-xl font-semibold text-slate-700 mb-4">Avance por Sucursal (Mes Actual)</h2>
        <div id="sucursal-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
          <p class="text-slate-500">Cargando datos de sucursales...</p>
        </div>
      </div>

      <!-- Productividad por promotor -->
      <div class="mt-6">
        <h2 class="text-xl font-semibold text-slate-700 mb-4">Productividad por Promotor (Mes Actual)</h2>
        <div id="productivity-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <p class="text-slate-500">Cargando productividad...</p>
        </div>
      </div>
    </div>

    <!-- Metas -->
    <div id="metas" class="tab-content hidden space-y-6">
      <h2 class="text-xl font-semibold text-slate-700">Establecer Metas Mensuales</h2>

      <form id="form-metas" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end p-4 bg-slate-50 rounded-lg border">
        <div>
          <label for="meta-mes" class="block text-sm font-medium text-gray-700">Mes</label>
          <select id="meta-mes" name="mes" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm"></select>
        </div>
        <div>
          <label for="meta-sucursal" class="block text-sm font-medium text-gray-700">Sucursal</label>
          <select id="meta-sucursal" name="sucursal" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm"></select>
        </div>
        <div>
          <label for="meta-producto" class="block text-sm font-medium text-gray-700">Producto</label>
          <select id="meta-producto" name="producto" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm"></select>
        </div>
        <div>
          <label for="meta-cantidad" class="block text-sm font-medium text-gray-700">Meta (Piezas)</label>
          <input type="number" id="meta-cantidad" name="meta" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Ej: 50">
        </div>
        <button type="submit" class="w-full md:w-auto text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5">Guardar Meta</button>
      </form>

      <div>
        <h3 class="text-lg font-medium text-slate-700 mb-2">Metas Guardadas</h3>
        <div class="max-h-96 overflow-y-auto rounded-lg border">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mes</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sucursal</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Producto</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Meta</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acción</th>
              </tr>
            </thead>
            <tbody id="lista-metas" class="bg-white divide-y divide-gray-200">
              <tr><td colspan="5" class="px-6 py-4 text-center text-slate-500">No hay metas guardadas.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Ventas y Promotores -->
    <div id="ventas" class="tab-content hidden space-y-6">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 space-y-6">
          <h2 class="text-xl font-semibold text-slate-700">Registro de Venta Diaria</h2>
          <form id="form-ventas" class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-slate-50 rounded-lg border">
            <div><label for="venta-fecha" class="block text-sm font-medium text-gray-700">Fecha</label><input type="date" id="venta-fecha" name="fecha" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" required></div>
            <div><label for="venta-sucursal" class="block text-sm font-medium text-gray-700">Sucursal</label><select id="venta-sucursal" name="sucursal" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" required></select></div>
            <div><label for="venta-producto" class="block text-sm font-medium text-gray-700">Producto</label><select id="venta-producto" name="producto" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" required></select></div>
            <div><label for="venta-promotor" class="block text-sm font-medium text-gray-700">Promotor</label><select id="venta-promotor" name="promotor" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" required><option value="">Seleccione un promotor...</option></select></div>
            <div class="md:col-span-2"><label for="venta-cantidad" class="block text-sm font-medium text-gray-700">Cantidad Vendida</label><input type="number" id="venta-cantidad" name="cantidad" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Ej: 5" required></div>
            <div class="md:col-span-2"><button type="submit" class="w-full text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-sm px-5 py-2.5">Registrar Venta</button></div>
          </form>

          <div>
            <div class="flex justify-between items-center mb-2">
              <h3 class="text-lg font-medium text-slate-700">Ventas Registradas</h3>
              <div>
                <button class="px-3 py-1 text-sm rounded-md bg-blue-100 text-blue-700 font-medium">Panel</button>
                <button class="px-3 py-1 text-sm rounded-md text-slate-500 hover:bg-slate-100" title="La vista de calendario es una futura mejora">Calendario</button>
              </div>
            </div>
            <div class="max-h-96 overflow-y-auto rounded-lg border">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sucursal</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Producto</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cant.</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Promotor</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acción</th>
                  </tr>
                </thead>
                <tbody id="lista-ventas" class="bg-white divide-y divide-gray-200">
                  <tr><td colspan="6" class="px-6 py-4 text-center text-slate-500">No hay ventas registradas.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="space-y-6">
          <h2 class="text-xl font-semibold text-slate-700">Gestión de Promotores</h2>

          <form id="form-promotores" class="p-4 bg-slate-50 rounded-lg border">
            <label for="promotor-nombre" class="block text-sm font-medium text-gray-700">Nombre del Promotor</label>
            <input type="text" id="promotor-nombre" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Ej: Juan Pérez" required>

            <label for="promotor-sucursal" class="block text-sm font-medium text-gray-700 mt-3">Sucursal</label>
            <select id="promotor-sucursal" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
              <!-- Opciones generadas por JS -->
            </select>

            <button type="submit" class="mt-3 w-full text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5">Agregar Promotor</button>
          </form>

          <div>
            <h3 class="text-lg font-medium text-slate-700 mb-2">Lista de Promotores</h3>
            <div id="lista-promotores" class="max-h-60 overflow-y-auto space-y-2">
              <p class="text-slate-500">Cargando promotores...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings -->
    <div id="settings" class="tab-content hidden space-y-6">
      <h2 class="text-xl font-semibold text-slate-700">Configuración y Sincronización</h2>
      <section class="p-4 bg-slate-50 rounded-lg border">
        <p class="text-sm text-slate-600 mb-3">Sincroniza tus datos con GitHub Gist (archivo ventas_data.json).</p>
        <form id="gist-config-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
          <div>
            <label for="gist-id" class="block text-sm font-medium text-gray-700">Gist ID</label>
            <input id="gist-id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="ej: a1b2c3...">
          </div>
          <div>
            <label for="gist-token" class="block text-sm font-medium text-gray-700">Personal Access Token</label>
            <input id="gist-token" type="password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="ghp_xxx...">
          </div>
          <div>
            <button id="btn-save-gist" class="px-4 py-2 text-white bg-indigo-600 rounded-lg">Guardar</button>
          </div>
          <div class="flex space-x-2">
            <button id="btn-download-gist" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg">Descargar</button>
            <button id="btn-upload-gist" class="px-4 py-2 bg-green-600 text-white rounded-lg">Subir</button>
          </div>
        </form>
      </section>
    </div>

  </main>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg text-white opacity-0 translate-y-10">
    <span id="toast-message"></span>
  </div>

  <!-- Modal simple (reutilizable) -->
  <div id="message-modal" class="modal fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center opacity-0 invisible">
    <div class="modal-content bg-white p-6 rounded-lg shadow-2xl w-full max-w-md">
      <h3 id="message-title" class="text-xl font-semibold mb-2">Título</h3>
      <div id="message-body" class="text-slate-700 mb-4"></div>
      <div class="flex justify-end">
        <button onclick="closeMessageModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Aceptar</button>
      </div>
    </div>
  </div>

  <!-- Scripts: Chart.js local, luego lógica -->
  <script src="./assets/js/chart.umd.min.js"></script>

  <script>
  /* ===========================
     CONSTANTES Y DATOS MAESTROS
     =========================== */
  const SUCURSALES = [
    "Coppel 363", "Coppel 385", "Coppel 716",
    "Elektra 218", "Chedraui 23", "Chedraui 99", "Chedraui 105"
  ];
  const PRODUCTOS = ["Amigo Kit", "CGI Cero", "Chip Express", "Portabilidad", "B63"];
  const MESES = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];

  const DB_NAME = "VentasAppDB";
  const DB_VERSION = 1;
  const STORES = { METAS: "metas", VENTAS: "ventas", PROMOTORES: "promotores", CONFIG: "config" };

  let db = null;
  let promotoresCache = [];
  let barChartInstance = null;
  let donutChartInstance = null;

  /* ===========================
     INICIALIZACIÓN
     =========================== */
  window.addEventListener('load', () => {
    setTodayDate();
    setupTabListeners();
    setupFormListeners();
    initDB();
    // attach modal safe handler
    const msgModal = document.getElementById('message-modal');
    if (msgModal) {
      msgModal.addEventListener('click', () => { try { closeMessageModal(); } catch(e){} });
      const inner = msgModal.querySelector('.modal-content');
      if (inner) inner.addEventListener('click', (e) => e.stopPropagation());
    }
  });

  function setTodayDate() {
    const today = new Date().toISOString().split('T')[0];
    const el = document.getElementById('venta-fecha');
    if (el) el.value = today;
  }

  function setupTabListeners() {
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.id.replace('tab-btn-','');
        showTab(id);
      });
    });
  }

  function showTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    const el = document.getElementById(tabId);
    if (el) el.classList.remove('hidden');
    const btn = document.getElementById('tab-btn-'+tabId);
    if (btn) btn.classList.add('active');

    if (tabId === 'dashboard') loadDashboardData();
    if (tabId === 'metas') loadMetas();
    if (tabId === 'ventas') {
      populateAllSelects(); // actualiza selects justo antes de mostrar
      loadPromotores();
      loadVentas();
    }
    if (tabId === 'settings') loadGistConfigLocal();
  }

  function setupFormListeners() {
    const fm = document.getElementById('form-metas');
    if (fm) fm.addEventListener('submit', handleAddMeta);
    const fp = document.getElementById('form-promotores');
    if (fp) fp.addEventListener('submit', handleAddPromotor);
    const fv = document.getElementById('form-ventas');
    if (fv) fv.addEventListener('submit', handleAddVenta);

    document.getElementById('btn-save-gist')?.addEventListener('click', async (e) => {
      e.preventDefault();
      const id = document.getElementById('gist-id').value.trim();
      const tok = document.getElementById('gist-token').value.trim();
      await saveGistConfig(id, tok);
    });
    document.getElementById('btn-download-gist')?.addEventListener('click', (e) => { e.preventDefault(); syncFromGist(); });
    document.getElementById('btn-upload-gist')?.addEventListener('click', (e) => { e.preventDefault(); syncToGist(); });
  }

  /* ===========================
     IndexedDB: init & upgrade
     =========================== */
  function initDB() {
    const request = indexedDB.open(DB_NAME, DB_VERSION);

    request.onerror = (event) => {
      console.error("Error al abrir IndexedDB:", event.target.error);
      updateDbStatus("Error de BD", true);
    };

    request.onsuccess = (event) => {
      db = event.target.result;
      updateDbStatus("BD Conectada", false);
      startApp();
    };

    request.onupgradeneeded = (event) => {
      const dbu = event.target.result;
      if (!dbu.objectStoreNames.contains(STORES.PROMOTORES)) {
        dbu.createObjectStore(STORES.PROMOTORES, { keyPath: 'id', autoIncrement: true });
      }
      if (!dbu.objectStoreNames.contains(STORES.METAS)) {
        const metasStore = dbu.createObjectStore(STORES.METAS, { keyPath: 'id', autoIncrement: true });
        metasStore.createIndex('metaUnica', ['mes','sucursal','producto'], { unique: true });
      }
      if (!dbu.objectStoreNames.contains(STORES.VENTAS)) {
        const ventasStore = dbu.createObjectStore(STORES.VENTAS, { keyPath: 'id', autoIncrement: true });
        ventasStore.createIndex('fecha', 'fecha', { unique: false });
        ventasStore.createIndex('sucursal', 'sucursal', { unique: false });
      }
      if (!dbu.objectStoreNames.contains(STORES.CONFIG)) {
        dbu.createObjectStore(STORES.CONFIG, { keyPath: 'id' });
      }
    };
  }

  function updateDbStatus(message, isError=false) {
    const statusEl = document.getElementById('db-status');
    if (!statusEl) return;
    statusEl.textContent = message;
    statusEl.classList.toggle('text-red-400', isError);
    statusEl.classList.toggle('text-green-400', !isError);
  }

  function startApp() {
    populateAllSelects();
    loadPromotores();
    loadMetas();
    loadDashboardData();
    loadGistConfigLocal();
  }

  /* ===========================
     POPULATE SELECTS (MESES, SUCURSALES, PRODUCTOS)
     =========================== */
  function populateAllSelects() {
    const selectsMes = [document.getElementById('meta-mes')];
    const selectsSucursal = [
      document.getElementById('meta-sucursal'),
      document.getElementById('venta-sucursal'),
      document.getElementById('promotor-sucursal')
    ];
    const selectsProducto = [
      document.getElementById('meta-producto'),
      document.getElementById('venta-producto')
    ];

    selectsMes.forEach(select => {
      if (!select) return;
      select.innerHTML = '';
      MESES.forEach((mes, idx) => select.add(new Option(mes, idx+1)));
      select.value = new Date().getMonth() + 1;
    });

    selectsSucursal.forEach(select => {
      if (!select) return;
      select.innerHTML = '<option value="">Seleccione sucursal...</option>';
      SUCURSALES.forEach(s => select.add(new Option(s, s)));
    });

    selectsProducto.forEach(select => {
      if (!select) return;
      select.innerHTML = '<option value="">Seleccione producto...</option>';
      PRODUCTOS.forEach(p => select.add(new Option(p, p)));
    });

    const ventaSucursal = document.getElementById('venta-sucursal');
    if (ventaSucursal) {
      ventaSucursal.addEventListener('change', (e) => populatePromotoresForSucursal(e.target.value));
    }
  }

  /* ===========================
     PROMOTORES (CRUD)
     =========================== */
  function handleAddPromotor(e) {
    e.preventDefault();
    const nombre = document.getElementById('promotor-nombre').value.trim();
    const sucursal = document.getElementById('promotor-sucursal').value || '';

    if (!nombre) return showToast("El nombre del promotor no puede estar vacío.", true);
    if (!sucursal) return showToast("Selecciona la sucursal del promotor.", true);

    const tx = db.transaction([STORES.PROMOTORES], 'readwrite');
    const store = tx.objectStore(STORES.PROMOTORES);
    const req = store.add({ nombre, sucursal });

    req.onsuccess = () => {
      showToast("Promotor agregado exitosamente.");
      document.getElementById('promotor-nombre').value = '';
      document.getElementById('promotor-sucursal').value = '';
      loadPromotores();
    };
    req.onerror = (err) => {
      console.error(err);
      showToast("Error al agregar promotor.", true);
    };
  }

  async function loadPromotores() {
    const promotores = await getAllFromDB(STORES.PROMOTORES);
    promotoresCache = promotores;
    const listaEl = document.getElementById('lista-promotores');
    const selectEl = document.getElementById('venta-promotor');

    listaEl.innerHTML = '';
    if (selectEl) selectEl.innerHTML = '<option value="">Seleccione un promotor...</option>';

    if (promotores.length === 0) {
      listaEl.innerHTML = '<p class="text-slate-500 text-sm">No hay promotores registrados.</p>';
      loadVentas();
      return;
    }

    promotores.forEach(p => {
      const div = document.createElement('div');
      div.className = 'flex justify-between items-center bg-white p-2 rounded-lg border';
      div.innerHTML = `
        <div>
          <div class="text-sm font-medium">${p.nombre}</div>
          <div class="text-xs text-slate-500">${p.sucursal || 'Sin sucursal'}</div>
        </div>
        <div class="flex items-center space-x-2">
          <button class="text-red-500 hover:text-red-700 text-xs" onclick="deleteItem('${STORES.PROMOTORES}', ${p.id}, loadPromotores)">Eliminar</button>
        </div>
      `;
      listaEl.appendChild(div);
    });

    const currentSucursal = document.getElementById('venta-sucursal')?.value || '';
    populatePromotoresForSucursal(currentSucursal);
    loadVentas();
  }

  function populatePromotoresForSucursal(sucursal) {
    const selectEl = document.getElementById('venta-promotor');
    if (!selectEl) return;
    selectEl.innerHTML = '<option value="">Seleccione un promotor...</option>';
    const filtered = promotoresCache.filter(p => !sucursal || p.sucursal === sucursal);
    filtered.forEach(p => selectEl.add(new Option(p.nombre, p.id)));
    if (filtered.length === 0) {
      const opt = new Option('No hay promotores en esta sucursal', '');
      opt.disabled = true;
      selectEl.add(opt);
    }
  }

  /* ===========================
     METAS (CRUD)
     =========================== */
  function handleAddMeta(e) {
    e.preventDefault();
    const form = e.target;
    const meta = {
      mes: parseInt(form.mes.value),
      sucursal: form.sucursal.value,
      producto: form.producto.value,
      meta: parseInt(form.meta.value,10)
    };
    if (!meta.mes || !meta.sucursal || !meta.producto || !meta.meta || meta.meta <= 0) {
      return showToast("Todos los campos son obligatorios y la meta debe ser positiva.", true);
    }
    const tx = db.transaction([STORES.METAS], 'readwrite');
    const store = tx.objectStore(STORES.METAS);
    const req = store.add(meta);
    req.onsuccess = () => {
      showToast("Meta guardada exitosamente.");
      form.reset();
      document.getElementById('meta-mes').value = new Date().getMonth()+1;
      loadMetas();
      loadDashboardData();
    };
    req.onerror = (e) => {
      if (e.target && e.target.error && e.target.error.name === 'ConstraintError') {
        showToast("Ya existe una meta para ese mes, sucursal y producto.", true);
      } else {
        console.error(e);
        showToast("Error al guardar la meta.", true);
      }
    };
  }

  async function loadMetas() {
    const metas = await getAllFromDB(STORES.METAS);
    const tbody = document.getElementById('lista-metas');
    tbody.innerHTML = '';
    if (metas.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-slate-500">No hay metas guardadas.</td></tr>';
      return;
    }
    metas.sort((a,b)=> a.mes - b.mes || a.sucursal.localeCompare(b.sucursal));
    metas.forEach(m=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap text-sm">${MESES[m.mes-1]}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm">${m.sucursal}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm">${m.producto}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${m.meta}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm"><button class="text-red-500 hover:text-red-700" onclick="deleteItem('${STORES.METAS}', ${m.id}, loadMetas)">Eliminar</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  /* ===========================
     VENTAS (CRUD)
     =========================== */
  function handleAddVenta(e) {
    e.preventDefault();
    const form = e.target;
    const venta = {
      fecha: form.fecha.value,
      sucursal: form.sucursal.value,
      producto: form.producto.value,
      promotorId: parseInt(form.promotor.value),
      cantidad: parseInt(form.cantidad.value,10)
    };
    if (!venta.fecha || !venta.sucursal || !venta.producto || !venta.promotorId || !venta.cantidad || venta.cantidad <= 0) {
      return showToast("Todos los campos son obligatorios y la cantidad debe ser positiva.", true);
    }
    const tx = db.transaction([STORES.VENTAS], 'readwrite');
    const store = tx.objectStore(STORES.VENTAS);
    const req = store.add(venta);
    req.onsuccess = () => {
      showToast("Venta registrada exitosamente.");
      form.producto.value = "";
      form.promotor.value = "";
      form.cantidad.value = "";
      form.producto.focus();
      loadVentas();
      loadDashboardData();
    };
    req.onerror = (err) => {
      console.error(err);
      showToast("Error al registrar la venta.", true);
    };
  }

  async function loadVentas() {
    const ventas = await getAllFromDB(STORES.VENTAS);
    const tbody = document.getElementById('lista-ventas');
    tbody.innerHTML = '';
    if (ventas.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-slate-500">No hay ventas registradas.</td></tr>';
      return;
    }
    ventas.sort((a,b)=> b.fecha.localeCompare(a.fecha));
    const promotorMap = new Map(promotoresCache.map(p => [p.id, p.nombre]));
    ventas.forEach(v=>{
      const tr = document.createElement('tr');
      const nombrePromotor = promotorMap.get(v.promotorId) || 'Desconocido';
      tr.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap text-sm">${v.fecha}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm">${v.sucursal}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm">${v.producto}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${v.cantidad}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm">${nombrePromotor}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm"><button class="text-red-500 hover:text-red-700" onclick="deleteItem('${STORES.VENTAS}', ${v.id}, loadVentas)">Eliminar</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  /* ===========================
     DASHBOARD -> Charts & Cards
     =========================== */
  async function loadDashboardData() {
    if (!db) return;
    const currentMonth = new Date().getMonth()+1;
    const currentYear = new Date().getFullYear();

    const [allMetas, allVentas] = await Promise.all([getAllFromDB(STORES.METAS), getAllFromDB(STORES.VENTAS)]);

    const metasMes = allMetas.filter(m => m.mes === currentMonth);
    const ventasMes = allVentas.filter(v => {
      const d = new Date(v.fecha);
      return (d.getMonth()+1) === currentMonth && d.getFullYear() === currentYear;
    });

    let totalMetaGeneral = 0;
    let totalVentaGeneral = 0;
    const dataPorProducto = {};
    PRODUCTOS.forEach(p => dataPorProducto[p] = { meta:0, venta:0 });

    metasMes.forEach(m => { totalMetaGeneral += (m.meta||0); if (dataPorProducto[m.producto]) dataPorProducto[m.producto].meta += (m.meta||0); });
    ventasMes.forEach(v => { totalVentaGeneral += (v.cantidad||0); if (dataPorProducto[v.producto]) dataPorProducto[v.producto].venta += (v.cantidad||0); });

    renderBarChart(dataPorProducto);
    renderDonutChart(totalVentaGeneral, totalMetaGeneral);

    const dataPorSucursal = {};
    SUCURSALES.forEach(s => dataPorSucursal[s] = { meta:0, venta:0 });
    metasMes.forEach(m => { if (dataPorSucursal[m.sucursal]) dataPorSucursal[m.sucursal].meta += (m.meta||0); });
    ventasMes.forEach(v => { if (dataPorSucursal[v.sucursal]) dataPorSucursal[v.sucursal].venta += (v.cantidad||0); });

    renderSucursalCards(dataPorSucursal);

    // Productividad por promotor (panel)
    renderProductivityPanel();
  }

  function renderBarChart(data) {
    const ctx = document.getElementById('barChart').getContext('2d');
    const labels = Object.keys(data);
    const metasData = labels.map(l => data[l].meta);
    const ventasData = labels.map(l => data[l].venta);

    if (barChartInstance) barChartInstance.destroy();
    barChartInstance = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label:'Meta', data:metasData, backgroundColor:'rgba(203,213,225,1)', borderColor:'rgba(100,116,139,1)', borderWidth:1 }, { label:'Venta', data:ventasData, backgroundColor:'rgba(37,99,235,1)', borderColor:'rgba(29,78,216,1)', borderWidth:1 }] },
      options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
    });
  }

  function renderDonutChart(venta, meta) {
    const ctx = document.getElementById('donutChart').getContext('2d');
    const porcentaje = (meta === 0) ? 0 : Math.round((venta/meta)*100);
    const data = { labels:['Alcanzado','Faltante'], datasets:[{ data:[venta, Math.max(0, meta-venta)], backgroundColor:['rgba(37,99,235,1)','rgba(226,232,240,1)'], borderColor:'#ffffff', borderWidth:2 }]};
    if (donutChartInstance) donutChartInstance.destroy();
    donutChartInstance = new Chart(ctx, { type:'doughnut', data, options:{ responsive:true, maintainAspectRatio:false, cutout:'70%', plugins:{ legend:{ display:false } } } });
    document.getElementById('donut-percentage').textContent = `${porcentaje}%`;
    document.getElementById('donut-percentage').classList.toggle('text-green-600', porcentaje >= 100);
    document.getElementById('donut-percentage').classList.toggle('text-slate-700', porcentaje < 100);
  }

  function renderSucursalCards(data) {
    const container = document.getElementById('sucursal-cards-container');
    container.innerHTML = '';
    if (Object.keys(data).length === 0) { container.innerHTML = '<p class="text-slate-500">No hay datos de sucursales.</p>'; return; }
    for (const sucursal in data) {
      const d = data[sucursal];
      const porcentaje = (d.meta === 0) ? 0 : Math.round((d.venta / d.meta) * 100);
      const progressColor = porcentaje >= 100 ? 'bg-green-500' : 'bg-blue-500';
      const card = document.createElement('div');
      card.className = 'bg-white p-4 rounded-lg shadow-md border';
      card.innerHTML = `
        <h4 class="font-semibold text-slate-700">${sucursal}</h4>
        <div class="text-xs text-slate-500 mb-2">${d.venta.toLocaleString()} / ${d.meta.toLocaleString()} Piezas</div>
        <div class="w-full bg-slate-200 rounded-full h-2.5"><div class="${progressColor} h-2.5 rounded-full" style="width:${Math.min(porcentaje,100)}%"></div></div>
        <div class="text-right text-sm font-medium mt-1 ${porcentaje >= 100 ? 'text-green-600' : 'text-slate-600'}">${porcentaje}%</div>
      `;
      container.appendChild(card);
    }
  }

  async function renderProductivityPanel() {
    if (!db) return;
    const currentMonth = new Date().getMonth()+1;
    const [allVentas, allMetas] = await Promise.all([getAllFromDB(STORES.VENTAS), getAllFromDB(STORES.METAS)]);
    const ventasMes = allVentas.filter(v => (new Date(v.fecha).getMonth()+1) === currentMonth);
    const totalsByPromotor = {};
    ventasMes.forEach(v => { const pid = v.promotorId; totalsByPromotor[pid] = (totalsByPromotor[pid]||0) + (v.cantidad||0); });
    const container = document.getElementById('productivity-container'); container.innerHTML = '';
    promotoresCache.forEach(p => {
      const total = totalsByPromotor[p.id] || 0;
      const metasSucursal = allMetas.filter(m => m.sucursal === p.sucursal && m.mes === currentMonth);
      const metaSucursalTotal = metasSucursal.reduce((s,mm)=> s + (mm.meta||0), 0);
      const porcentaje = metaSucursalTotal === 0 ? 0 : Math.round((total/metaSucursalTotal)*100);
      const card = document.createElement('div');
      card.className = 'bg-white p-4 rounded-lg shadow-md border';
      card.innerHTML = `
        <div class="flex justify-between items-start">
          <div><div class="text-sm font-medium text-slate-700">${p.nombre}</div><div class="text-xs text-slate-500">${p.sucursal||'Sin sucursal'}</div></div>
          <div class="text-lg font-bold text-slate-800">${total}</div>
        </div>
        <div class="w-full bg-slate-200 rounded-full h-2.5 mt-3"><div class="${porcentaje >= 100 ? 'bg-green-500' : 'bg-blue-500'} h-2.5 rounded-full" style="width:${Math.min(porcentaje,100)}%"></div></div>
        <div class="text-right text-sm font-medium mt-2 ${porcentaje>=100? 'text-green-600' : 'text-slate-600'}">${porcentaje}% cumplimiento (relativo a meta sucursal)</div>
      `;
      container.appendChild(card);
    });
    if (promotoresCache.length === 0) container.innerHTML = '<p class="text-slate-500">No hay promotores para mostrar productividad.</p>';
  }

  /* ===========================
     AUXILIARES: getAll, delete, toast
     =========================== */
  function getAllFromDB(storeName) {
    return new Promise((resolve, reject) => {
      if (!db) { reject("La base de datos no está inicializada."); return; }
      const tx = db.transaction([storeName], 'readonly'); const store = tx.objectStore(storeName);
      const req = store.getAll();
      req.onsuccess = () => resolve(req.result);
      req.onerror = (e) => reject(e.target.error);
    });
  }

  function deleteItem(storeName, id, callbackOnSuccess) {
    if (!confirm('¿Estás seguro de que deseas eliminar este registro? Esta acción no se puede deshacer.')) return;
    const tx = db.transaction([storeName], 'readwrite'); const store = tx.objectStore(storeName);
    const req = store.delete(id);
    req.onsuccess = () => { showToast("Registro eliminado."); if (callbackOnSuccess) callbackOnSuccess(); loadDashboardData(); };
    req.onerror = (e) => { showToast("Error al eliminar el registro.", true); console.error(e.target.error); };
  }

  function showToast(message, isError=false) {
    const toast = document.getElementById('toast'); const tmsg = document.getElementById('toast-message');
    tmsg.textContent = message;
    toast.classList.toggle('bg-red-500', isError); toast.classList.toggle('bg-gray-800', !isError);
    toast.classList.remove('opacity-0','translate-y-10'); toast.classList.add('opacity-100','translate-y-0');
    setTimeout(()=>{ toast.classList.remove('opacity-100','translate-y-0'); toast.classList.add('opacity-0','translate-y-10'); }, 3000);
  }

  function closeMessageModal() {
    const modal = document.getElementById('message-modal'); if (!modal) return;
    modal.classList.add('opacity-0','invisible'); modal.classList.remove('open');
  }
  function openMessageModal(title, html) {
    document.getElementById('message-title').textContent = title;
    document.getElementById('message-body').innerHTML = html;
    const modal = document.getElementById('message-modal'); modal.classList.remove('opacity-0','invisible'); modal.classList.add('open');
  }

  /* ===========================
     SYNC: GitHub Gist (save/load ventas_data.json)
     =========================== */
  function syncToGist() {
  const cfg = await loadGistConfigLocal();
  if (!cfg.gistId || !cfg.gistToken)
    return showToast("Configura Gist ID y Token en Configuración.", true);

  try {
    showToast("Fusión local + remota (Gist)...");

    // 1. Datos locales
    const localPromotores = await getAllFromDB(STORES.PROMOTORES);
    const localMetas = await getAllFromDB(STORES.METAS);
    const localVentas = await getAllFromDB(STORES.VENTAS);

    // 2. Descargar remoto
    const resp = await fetch(`https://api.github.com/gists/${cfg.gistId}`, {
      headers: {
        Authorization: `token ${cfg.gistToken}`,
        Accept: "application/vnd.github.v3+json"
      }
    });

    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

    const gist = await resp.json();
    let remote = { promotores: [], metas: [], ventas: [] };

    if (gist.files?.["ventas_data.json"]?.content) {
      try {
        remote = JSON.parse(gist.files["ventas_data.json"].content);
      } catch (err) {
        console.warn("JSON remoto inválido, usando arrays vacíos.");
      }
    }

    // 3. FUSIÓN sin duplicados por id
    const mergedPromotores = mergeArrays(remote.promotores, localPromotores);
    const mergedMetas = mergeArrays(remote.metas, localMetas);
    const mergedVentas = mergeArrays(remote.ventas, localVentas);

    // 4. Subir fusión
    const payload = {
      description: "Datos VentasApp (Merge)",
      files: {
        "ventas_data.json": {
          content: JSON.stringify(
            {
              promotores: mergedPromotores,
              metas: mergedMetas,
              ventas: mergedVentas
            },
            null,
            2
          )
        }
      }
    };

    const upload = await fetch(`https://api.github.com/gists/${cfg.gistId}`, {
      method: "PATCH",
      headers: {
        Authorization: `token ${cfg.gistToken}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify(payload)
    });

    if (!upload.ok) throw new Error(`HTTP ${upload.status}`);

    showToast("Fusión completada y subida correctamente.");
  } catch (e) {
    console.error(e);
    showToast("Error subiendo a Gist: " + (e.message || e), true);
  }
}  /* ===========================
     SERVICE WORKER registro
     =========================== */
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').then(()=> console.log('SW registrado')).catch(e => console.warn('SW error', e));
  }
  /* ===========================
     FIN
     =========================== */
  </script>
</body>
</html>
